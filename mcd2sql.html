<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>mcd2sql</title>
        <meta name="author" content="Flammrock">
        <style>
            html, body {

            }
            .t {
                width: 100%;
                height: 40vh;
            }
        </style>
    </head>
    <body>
        <span>MCD Script:</span><br />
        <textarea class="t" id="mcd"></textarea><br />
        
        <span>SQL Output:</span><br />
        <textarea class="t" id="sql"></textarea><br />
        <button id="compile">compile</button>
        <script>
            
            var data = `
Plat : Nom, Provenance
Catégorie Resto :
Personne :
Map : Emplacement
Cuisinier :
SIRET : Nom, Horaires, Adresse, Type/origine, Place disponible, Carte

contient , 11 Menu (carte),1N> Plat
Patron :
Est un1 , XX Salariés , XX Client , XX Patron , XX> Personne
Salariés : Nom, Numéro de sécu, Nom du restaurants
Est un2 , XX Cuisinier , XX Serveur , XX Voiturier , XX> Salariés
Voiturier :

Menu (carte) : Restaurant, Créneaux
Dirige , 1N Patron, 1N> Restautant
Client : Id, Nom, Prénom, Sexe, Age, Crédit, Location, Experience, xp
Application :
Serveur :
Commentaire : Restaurant, Client, Commentaire, Note

Possede , 11 Restautant , 0N> Menu (carte)
Restautant : Siret, Nom, Horaire, Adresse, Type/origine, Place disponible, Carte
Vie,11 Client,0N> Experience
Experience : Nom client, Nom restaurant, Date
Table : Nb de place, Id_table, Restaurant
Disponibilité : Restaurant, h-ouverture, h-fermeture
            `;
            
            document.getElementById('mcd').value = data;
            
            //console.log(data);
            
            String.prototype.splitAndKeep = function(separator, method='seperate'){
                var str = this;
                function splitAndKeep(str, separator, method='seperate'){
                    if(method == 'seperate'){
                        str = str.split(new RegExp(`(${separator})`, 'g'));
                    }else if(method == 'infront'){
                        str = str.split(new RegExp(`(?=${separator})`, 'g'));
                    }else if(method == 'behind'){
                        str = str.split(new RegExp(`(.*?${separator})`, 'g'));
                        str = str.filter(function(el){return el !== "";});
                    }
                    return str;
                }
                if(Array.isArray(separator)){
                    var parts = splitAndKeep(str, separator[0], method);
                    for(var i = 1; i < separator.length; i++){
                        var partsTemp = parts;
                        parts = [];
                        for(var p = 0; p < partsTemp.length; p++){
                            parts = parts.concat(splitAndKeep(partsTemp[p], separator[i], method));
                        }
                    }
                    return parts;
                }else{
                    return splitAndKeep(str, separator, method);
                }
            };
            
            let islineok = (line) => {
                return line.trim()!="";
            };
            
            let filterlines = (lines) => {
                let flines = [];
                for (let i = 0; i < lines.length; i++) {
                    if (islineok(lines[i])) flines.push(lines[i]);
                }
                return flines;
            };
            
            let extract = (txt) => {
                return txt.replace(/\r\n/g,'\n').split('\n');
            };
            
            let iterate = (arr,fn) => {
                let data = [];
                let len = arr.length;
                for (let i = 0; i < len; i++) {
                    let r = fn(arr[i],i,len);
                    if (r==null) continue;
                    if (Array.isArray(r)) {
                        data.push(...r);
                    } else {
                        data.push(r);
                    }
                }
                return data;
            };
            
            let tokenize = (line) => {
                let sep = [',',':'];
                let v = 0;
                return iterate(line.splitAndKeep(sep),(token,i,len) => {
                    let t = token.trim();
                    if (i==1 && t==':') {
                        v = 1;
                    } else if (i==1) {
                        v = 2;
                    }
                    if (v==2 && t!=',') {
                        let size = 2;
                        if (t.charAt(2)=='<' || t.charAt(2)=='>') size = 3;
                        let n = t.substring(0,size);
                        let m = t.substring(size).trim();
                        return [
                            n,
                            m
                        ];
                    } else {
                        return t;
                    }
                });
            };
            
            let istable = (tokens) => {
                return tokens.length > 1 && tokens[1]==':';
            };
            
            let isassociation = (tokens) => {
                if (tokens.length <= 2) return false;
                for (var i = 2; i < tokens.length; i+=3) {
                    if (tokens[i].length < 2) return false;
                    if (tokens[i].substring(0,2)=='XX') return false;
                }
                return true;
            };
            
            let isinheritance = (tokens) => {
                if (tokens.length <= 2) return false;
                for (var i = 2; i < tokens.length; i+=3) {
                    if (tokens[i].length < 2) return false;
                    if (tokens[i].substring(0,2)!='XX') return false;
                }
                return true;
            };
            
            let SQL = {
            
                Table: class Table {
                
                    constructor(tokens) {
                        this.name = typeof tokens !== 'undefined' ? tokens[0] : null;
                        this.properties = [];
                        this.foreigntable = [];
                        if (typeof tokens !== 'undefined') {
                            for (var i = 1; i < tokens.length; i++) {
                                if (tokens[i]==','||tokens[i]==':'||tokens[i]=='') continue;
                                this.properties.push(tokens[i]);
                            }
                        }
                    }
                    
                    addForeign(table) {
                        this.foreigntable.push(table);
                    }
                    
                    buildProperties() {
                        let p = '';
                        let len = this.properties.length;
                        for (var i = 0; i < len; i++) {
                            p += '\t'+this.properties[i] + ' text' + (i==len-1?'':',\n');
                        }
                        return p;
                    }
                    
                    buildForeign() {
                        let f = '';
                        let ff = '';
                        let len = this.foreigntable.length;
                        for (var i = 0; i < len; i++) {
                            let t = this.foreigntable[i];
                            ff += '\t'+t.name+'_id integer,\n';
                            f += '\t'+'CONSTRAINT fk_'+t.name+' FOREIGN KEY('+t.name+'_id) REFERENCES '+t.name+'(id)' + (i==len-1?'':',\n');
                        }
                        return ff+f;
                    }
                    
                    toString() {
                        let p = this.buildProperties();
                        let f = this.buildForeign();
                        let t = iterate(
                        `
                        CREATE TABLE ${this.name} (
                            ${'\t'}id serial PRIMARY KEY${p==''&&f==''?'':p==''?',\n'+f:f==''?',\n'+p:',\n'+p+',\n'+f}
                        );
                        `.split('\n'),(s) => s.replace(/^[ ]+|[ ]+$/g, '')).join('\n');
                        //console.warn(t);
                        return t;
                    
                    }
                    
                },
                Association: class Association {
                
                    constructor(tokens) {
                        this.name = tokens[0];
                        this.links = [];
                        for (var i = 1; i < tokens.length; i++) {
                            if (tokens[i]==',') continue;
                            this.links.push({
                                dim:tokens[i],
                                name:tokens[i+1]
                            });
                            i++;
                        }
                    }
                    
                },
                Inheritance: class Inheritance {
                
                    constructor(tokens) {
                        this.name = tokens[0];
                        this.children = [];
                        this.parent = tokens[tokens.length-1];
                        for (var i = 1; i < tokens.length-1; i++) {
                            if (tokens[i]==',') continue;
                            if (tokens[i].length > 1 && tokens[i].substring(0,2)=='XX') continue;
                            this.children.push(tokens[i]);
                        }
                    }
                    
                }
            
            };
            
            let sqlfactory = (tokens) => {
                if (istable(tokens)) {
                    //console.log('TABLE',tokens);
                    return new SQL.Table(tokens);
                } else if (isassociation(tokens)) {
                    //console.log('ASSOCIATION',tokens);
                    return new SQL.Association(tokens);
                } else if (isinheritance(tokens)) {
                    return new SQL.Inheritance(tokens);
                    //console.log('INHERITANCE',tokens);
                }
            };
            
            let sqlextractor = (model) => {
                return (obj) => {
                    if (obj instanceof model) {
                        return obj;
                    }
                    return null;
                };
            };
            
            let dict = (arr) => {
                let d = {};
                iterate(arr,(obj) => {
                    d[obj.name] = obj;
                });
                return d;
            };
            
            let dictexists = (dict,name) => {
                return typeof dict[name] !== 'undefined';
            };
            
            let dictget = (dict,name) => {
                return dict[name];
            };
            
            let sqlsolve = (sqlobject) => {
            
                let tables = iterate(sqlobject,sqlextractor(SQL.Table));
                let associations = iterate(sqlobject,sqlextractor(SQL.Association));
                let inheritances = iterate(sqlobject,sqlextractor(SQL.Inheritance));
                
                // build table dictionnary
                let hashtables = dict(tables);
                
                let cardinalityparse = (ass) => {
                    return [ass.dim.substring(0,1),ass.dim.substring(1,2)];
                };
                
                let MODE = {
                    _NN:1,
                    _1N:2,
                    _N1:3,
                    _11:4
                };
                
                // cardinality solver
                let cardinalitysolve = (ass1,ass2) => {
                    let c1 = cardinalityparse(ass1);
                    let c2 = cardinalityparse(ass2);
                    if (c1[1].toLowerCase()=='n' && c2[1].toLowerCase()=='n') {
                        return MODE._NN;
                    } else if (c1[1].toLowerCase()!='n' && c2[1].toLowerCase()=='n') {
                        return MODE._1N;
                    } else if (c1[1].toLowerCase()=='n' && c2[1].toLowerCase()!='n') {
                        return MODE._N1;
                    } else {
                        return MODE._11;
                    }
                };
                
                let solve = (name,ass1,ass2) => {
                
                    if (!dictexists(hashtables,ass1.name)) {
                        throw new Error('"'+ass1.name+'" table not found.');
                    }
                    
                    if (!dictexists(hashtables,ass2.name)) {
                        throw new Error('"'+ass1.name+'" table not found.');
                    }
                    
                    let mode = cardinalitysolve(ass1,ass2);
                    
                    if (mode==MODE._NN) {
                        let t = new SQL.Table();
                        t.name = name;
                        t.addForeign(dictget(hashtables,ass1.name));
                        t.addForeign(dictget(hashtables,ass2.name));
                        return t;
                    } else if (mode==MODE._11) {
                        let t1 = dictget(hashtables,ass1.name);
                        let t2 = dictget(hashtables,ass2.name);
                        t1.addForeign(t2);
                        t2.addForeign(t1);
                    } else if (mode==MODE._1N) {
                        let t1 = dictget(hashtables,ass1.name);
                        let t2 = dictget(hashtables,ass2.name);
                        t1.addForeign(t2);
                        //t2.addForeign(t1);
                    } else if (mode==MODE._N1) {
                        let t1 = dictget(hashtables,ass1.name);
                        let t2 = dictget(hashtables,ass2.name);
                        //t1.addForeign(t2);
                        t2.addForeign(t1);
                    }
                
                    return null;
                
                };
                
                // solve associations
                iterate(associations,(ass) => {
                    
                    let links = ass.links;
                    
                    if (links.length > 2) {
                        throw new Error('only 2 associations are supported.');
                    }
                    
                    var ass1 = links[0];
                    var ass2 = links[1];
                    
                    
                    let ntable = solve(ass.name,ass1,ass2);
                    if (ntable!=null) tables.push(ntable);
                    
                    
                });
                
                return tables;
            
            };
            
            let display = (sqlcompiled) => {
                let txt = '';
                iterate(sqlcompiled, (t) => {
                    txt += t.toString() + '\n\n';
                });
                return txt;
            };
            
            let mtd2sql = (txt) => {
            
                let lines = filterlines(extract(txt));
                
                let sqlobject = iterate(lines,(line) => {
                
                    let tokens = tokenize(line);
                    
                    return sqlfactory(tokens);
                    
                });
                
                let sqlcompiled = sqlsolve(sqlobject);
                
                return sqlcompiled;
            
            };
            
            //let TT = mtd2sql(data);
            //let TXT = display(TT);
            //document.write('<pre>'+TXT+'</pre>');
            
            document.getElementById('compile').onclick = (e) => {
                let v = document.getElementById('mcd').value;
                document.getElementById('sql').value = display(mtd2sql(v));
            }; 
            
        </script>
    </body>
</html>